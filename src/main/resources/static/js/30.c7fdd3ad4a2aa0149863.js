webpackJsonp([30],{"6erQ":function(e,t){},oj83:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=a("Gu7T"),i=a.n(o),n=a("Vo7i"),s=a("mw3O"),l=a.n(s);function r(e){return Object(n.a)({url:"/module/package/getCodeLogInfo",method:"get",params:e})}var c={name:"ModuleDetails",data:function(){return{loading:!1,listLoading:!1,detailsType:1,params:{},tableData:[],dialogVisible:!1,dialogLogVisible:!1,logData:{list:[],row:{}},packagefileList:[],dialogData:{type:"add",row:{}},rules:{},formData:{moduleType:1,programFileName:"",contentName:"",codeUrl:""},versionSelect:[],versionRow:{},branchSelect:[],branchRow:{},envPermission:{},envId:"",options:{target:"/module/upload",testChunks:!1,singleFile:!0}}},methods:{onFileSuccess:function(e,t,a,o){if(a){var i=JSON.parse(a).data;if(i){var n=i.split("/"),s=n[n.length-1];this.packagefileList=[],this.packagefileList.push(s)}}},onFileError:function(e,t,a,o){console.log(a)},fileUpload:function(){this.$refs.uploader.uploader.resume()},goBack:function(){this.$router.push({path:"/product/index",query:{data:this.params.envId}})},openLog:function(e){var t=this;this.logData.list=[];var a=this;a.logData.row=e,r({packageId:e.id}).then(function(e){var o=e.data.data;200==e.data.code?(a.logData.list=o.sort(function(e,t){return t.reversion-e.reversion}),t.dialogLogVisible=!0):a.$message({message:e.data.msg,type:"warning"})})},deleteModule:function(e){var t=this,a=this;this.$confirm("确定要删除吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){var o;(o={packageId:e},Object(n.a)({url:"/module/package/delPackageInfo",method:"post",data:o,transformRequest:[function(e){return e=l.a.stringify(e)}]})).then(function(e){var o=e.data.code;t.$message({message:200==o?"删除成功":e.data.msg,type:200==o?"success":"error"}),200==o&&a.getData(a.params.moduleId)})}).catch(function(){t.$message({type:"info",message:"已取消删除"})})},updateAllCode:function(){var e=this,t=this;this.$confirm("确定要更新全部模块代码吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){var a;t.listLoading=!0,(a={moduleId:t.params.moduleId},Object(n.a)({url:"/module/package/updateAllCode",method:"post",data:a,timeout:18e4,transformRequest:[function(e){return e=l.a.stringify(e)}]})).then(function(a){var o=a.data.code;e.$message({message:200==o?"更新成功":a.data.msg,type:200==o?"success":"error"}),200==o&&t.getData(t.params.moduleId),t.listLoading=!1})}).catch(function(){e.$message({type:"info",message:"已取消更新"})})},closeForm:function(){this.resetFields(),this.packagefileList=[],this.dialogData={type:"add",row:{}}},resetFields:function(){this.formData={moduleType:1,programFileName:"",contentName:"",codeUrl:""}},submitForm:function(){var e,t=this;if("edit"==t.dialogData.type)(e=t.formData,Object(n.a)({url:"/module/package/updatePackageInfo",method:"post",transformRequest:[function(e){return e=l.a.stringify(e)}],data:e})).then(function(e){t.closeDialog(e)});else{var a={};1!=t.detailsType&&4!=t.detailsType||((a=new FormData).append("moduleId",t.formData.moduleId),a.append("moduleType",t.formData.moduleType),a.append("programFileName",t.packagefileList[0]||""));var o=1==t.detailsType||4==t.detailsType?a:t.formData;(function(e){var t={url:"/module/package/insertPackageInfo",method:"post",data:e.params};return 0!=e.type&&2!=e.type||(t.transformRequest=[function(e){return e=l.a.stringify(e)}]),Object(n.a)(t)})({type:t.detailsType,params:o}).then(function(e){t.closeDialog(e)})}},closeDialog:function(e){200==e.data.code?(this.dialogVisible=!1,this.getData(this.params.moduleId)):this.$message({message:e.data.msg,type:"error"})},openModuleDialog:function(e,t){this.dialogVisible=!0,this.dialogData={type:t,row:e},this.formData.moduleType=this.detailsType,"edit"==t?(this.formData.packageId=e.id,this.formData.contentName=e.contentName,this.formData.codeUrl=e.codeUrl):this.formData.moduleId=this.params.moduleId},getData:function(e){var t,a=this;(t={moduleId:e},Object(n.a)({url:"/module/package/getByModuleId",method:"get",params:t})).then(function(e){a.tableData=e.data.data,setTimeout(function(){a.listLoading=!1},200)})},updateReversion:function(e){var t=this,a=this;this.$confirm("确定要更新版本吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){var o;a.listLoading=!0,(o=e,Object(n.a)({url:"/module/package/updateReversion",method:"post",data:o,transformRequest:[function(e){return e=l.a.stringify(e)}]})).then(function(e){var o=e.data.code;t.$message({message:200==o?"更新成功!":e.data.msg,type:200==o?"success":"error"}),200==o&&(a.getData(a.params.moduleId),a.versionSelect=[]),setTimeout(function(){a.listLoading=!1},200)})}).catch(function(){t.versionRow.row.reversion2="",t.$message({type:"info",message:"已取消更新"})})},versionSelectChange:function(e){var t={packageId:this.versionRow.row.id,reversion:"Latest"==e?-1:e};this.updateReversion(t)},getVersionInfo:function(e){if(this.permissionCheck("module_manage_svn_version")){var t=e.row,a=this;a.versionSelect=[],a.versionRow=e,r({packageId:t.id}).then(function(e){var t=e.data.data;200==e.data.code?(t.forEach(function(e){a.versionSelect.push({name:e.reversion})}),a.versionSelect.sort(function(e,t){return t.name-e.name}),a.versionSelect=[{name:"Latest"}].concat(i()(a.versionSelect))):a.$message({message:e.data.msg,type:"warning"})})}else this.$message({type:"error",message:"权限不足！"})},changeBranch:function(e){var t=this,a=this;this.$confirm("确定要切换分支吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){var o;a.listLoading=!0,(o=e,Object(n.a)({url:"/module/package/change/branch",method:"post",data:o,transformRequest:[function(e){return e=l.a.stringify(e)}]})).then(function(e){var o=e.data.code;t.$message({message:200==o?"切换成功!":e.data.msg,type:200==o?"success":"error"}),200==o&&(a.getData(a.params.moduleId),a.branchSelect=[]),setTimeout(function(){a.listLoading=!1},200)})}).catch(function(){t.branchRow.row.gitBranch2="",t.$message({type:"info",message:"已取消切换"})})},branchSelectChange:function(e){var t={envId:this.envId,packageId:this.branchRow.row.id,branchName:e};console.log(t),this.changeBranch(t)},getRemoteBranch:function(e){if(this.permissionCheck("module_manage_svn_version")){var t,a=e.row,o=this;o.branchSelect=[],o.branchRow=e,(t={packageId:a.id,envId:this.envId},Object(n.a)({url:"/module/package/git/remote/branchs",method:"get",params:t})).then(function(e){var t=e.data.data;200==e.data.code?t.forEach(function(e){o.branchSelect.push({name:e})}):o.$message({message:e.data.msg,type:"warning"})})}else this.$message({type:"error",message:"权限不足！"})},permissionCheck:function(e){var t=[];return void 0!=this.envPermission&&this.envPermission.permissionSet&&(t=this.envPermission.permissionSet),t.includes(e)}},created:function(){var e=this.$store.state.app.lastRouteData;if(this.params=e,e){this.detailsType=e.moduleType;var t=e.moduleId;this.listLoading=!0,this.getData(t),this.envPermission=e.permission,this.envId=e.envId}}},d={render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",[a("el-main",[a("el-row",{staticClass:"filter-container",attrs:{type:"flex"}},[e.permissionCheck("module_manage_package_add")?a("el-button",{attrs:{icon:"el-icon-edit",size:"mini",type:"primary"},on:{click:function(t){return e.openModuleDialog({},"add")}}},[e._v("新增\n        ")]):e._e(),e._v(" "),a("el-button",{attrs:{icon:"el-icon-back",size:"mini",type:"primary"},on:{click:e.goBack}},[e._v("返回")])],1),e._v(" "),a("el-card",[a("el-row",{staticClass:"border-class",attrs:{justify:"space-between",type:"flex"}},[a("el-col",{attrs:{span:18}},[a("div",{staticClass:"table-class"},[a("span",[e._v("模块："+e._s(e.params.moduleName))])])]),e._v(" "),a("el-col",{attrs:{span:6}},[a("div",{staticClass:"table-class",staticStyle:{float:"right"}},[e.permissionCheck("module_manage_update_all_code")?a("el-button",{staticClass:"button-m-small",attrs:{size:"mini",type:"primary"},on:{click:e.updateAllCode}},[e._v("更新全部\n              ")]):e._e()],1)])],1),e._v(" "),a("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.listLoading,expression:"listLoading"}],staticStyle:{width:"100%"},attrs:{data:e.tableData,"element-loading-text":"拼命加载中...","highlight-current-row":!0}},[0==e.detailsType||2==e.detailsType||3==e.detailsType||5==e.detailsType?a("el-table-column",{attrs:{align:"center","header-align":"center",label:"目录名称",prop:"contentName"}}):e._e(),e._v(" "),0==e.detailsType||2==e.detailsType||3==e.detailsType||5==e.detailsType?a("el-table-column",{attrs:{align:"left","header-align":"center",label:0==e.detailsType||3==e.detailsType||5==e.detailsType?"svn地址":"git地址",prop:"codeUrl"}}):e._e(),e._v(" "),1==e.detailsType||4==e.detailsType?a("el-table-column",{attrs:{align:"center","header-align":"center",label:"包名",prop:"packagePathName"}}):e._e(),e._v(" "),a("el-table-column",{attrs:{align:"center",label:"上传时间",prop:"createTime",width:"180"}}),e._v(" "),0==e.detailsType||2==e.detailsType||3==e.detailsType||5==e.detailsType?a("el-table-column",{attrs:{align:"center",label:"版本号",prop:"codeReversion"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-select",{directives:[{name:"loading",rawName:"v-loading",value:t.row.loading,expression:"scope.row.loading"}],staticStyle:{width:"35%"},attrs:{placeholder:-1==t.row.codeReversion?"Latest":t.row.codeReversion.toString()},on:{change:e.versionSelectChange,"visible-change":function(a){return e.getVersionInfo(t)}},model:{value:t.row.reversion2,callback:function(a){e.$set(t.row,"reversion2",a)},expression:"scope.row.reversion2"}},e._l(e.versionSelect,function(e,t){return a("el-option",{key:t,attrs:{label:e.name,value:e.name}})}),1)]}}],null,!1,425182521)}):e._e(),e._v(" "),2==e.detailsType||5==e.detailsType?a("el-table-column",{attrs:{align:"center",label:"分支",prop:"codeReversion"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-select",{directives:[{name:"loading",rawName:"v-loading",value:t.row.loading,expression:"scope.row.loading"}],staticStyle:{width:"35%"},attrs:{placeholder:t.row.gitBranch},on:{change:e.branchSelectChange,"visible-change":function(a){return e.getRemoteBranch(t)}},model:{value:t.row.gitBranch2,callback:function(a){e.$set(t.row,"gitBranch2",a)},expression:"scope.row.gitBranch2"}},e._l(e.branchSelect,function(e,t){return a("el-option",{key:t,attrs:{label:e.name,value:e.name}})}),1)]}}],null,!1,1025589587)}):e._e(),e._v(" "),a("el-table-column",{attrs:{align:"center",label:"操作",width:"300"},scopedSlots:e._u([{key:"default",fn:function(t){return[0!=e.detailsType&&2!=e.detailsType&&3!=e.detailsType&&5!=e.detailsType||!e.permissionCheck("module_manage_svn_update")?e._e():a("el-button",{staticClass:"button-m-small",attrs:{size:"mini",type:"primary"},on:{click:function(a){return e.openModuleDialog(t.row,"edit")}}},[e._v("编辑\n              ")]),e._v(" "),e.permissionCheck("module_manage_package_delete")?a("el-button",{staticClass:"button-m-small",attrs:{size:"mini",type:"danger"},on:{click:function(a){return e.deleteModule(t.row.id)}}},[e._v("删除\n              ")]):e._e(),e._v(" "),0!=e.detailsType&&2!=e.detailsType&&3!=e.detailsType&&5!=e.detailsType||!e.permissionCheck("module_manage_svn_log_show")?e._e():a("el-button",{staticClass:"button-m-small",attrs:{size:"mini",type:"primary"},on:{click:function(a){return e.openLog(t.row)}}},[e._v("查看日志\n              ")])]}}])})],1)],1),e._v(" "),a("el-dialog",{attrs:{visible:e.dialogLogVisible,title:"日志详情",top:"5vh",width:"66%;","close-on-click-modal":e.elDialogCloseOnClickModal,"destroy-on-close":e.elDialogDestroyOnClose},on:{"update:visible":function(t){e.dialogLogVisible=t}}},[a("div",{staticStyle:{"max-height":"75vh"}},[a("div",{staticStyle:{"word-wrap":"break-word","padding-bottom":"10px","max-height":"5vh"}},[a("span",[e._v(e._s(e.logData.row.codeUrl))])]),e._v(" "),e.logData.list?a("div",{staticClass:"log-container",staticStyle:{height:"75vh"}},[a("el-timeline",e._l(e.logData.list,function(t,o){return a("el-timeline-item",{key:o,attrs:{timestamp:t.opDate,placement:"top"}},[a("el-card",[a("p",[e._v("Reversion: "+e._s(t.reversion))]),e._v(" "),a("p",[e._v("Author: "+e._s(t.author))]),e._v(" "),a("p",[e._v("message: "+e._s(t.commitLog))]),e._v(" "),e._l(t.changeContent,function(t,o){return a("p",{key:o,staticStyle:{"word-wrap":"break-word"}},[e._v("\n                    "+e._s(t)+"\n                  ")])})],2)],1)}),1)],1):e._e()]),e._v(" "),a("div",{attrs:{slot:"footer"},slot:"footer"},[a("el-button",{attrs:{type:"primary"},on:{click:function(t){e.dialogLogVisible=!1}}},[e._v("关闭")])],1)]),e._v(" "),a("el-dialog",{attrs:{title:"add"==e.dialogData.type?"添加":"更新",visible:e.dialogVisible,top:"5vh","close-on-click-modal":e.elDialogCloseOnClickModal,"destroy-on-close":e.elDialogDestroyOnClose},on:{"update:visible":function(t){e.dialogVisible=t},close:e.closeForm}},[a("el-form",{ref:"formModule",staticStyle:{width:"100%","max-height":"70vh"},attrs:{model:e.formData,rules:e.rules,"label-position":"left","label-width":"85px"}},[0==e.detailsType||2==e.detailsType||3==e.detailsType?[a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:2==e.detailsType?9:12}},[a("el-form-item",{attrs:{label:0==e.detailsType||3==e.detailsType?"svn地址":"git地址",prop:"codeUrl"}},[a("el-input",{model:{value:e.formData.codeUrl,callback:function(t){e.$set(e.formData,"codeUrl",t)},expression:"formData.codeUrl"}})],1)],1),e._v(" "),a("el-col",{directives:[{name:"show",rawName:"v-show",value:2==e.detailsType,expression:"detailsType == 2"}],attrs:{span:5}},[a("el-form-item",{attrs:{label:"分支","label-width":"50px"}},[a("el-input",{model:{value:e.formData.gitBranch,callback:function(t){e.$set(e.formData,"gitBranch",t)},expression:"formData.gitBranch"}})],1)],1),e._v(" "),a("el-col",{attrs:{span:2==e.detailsType?9:12}},[a("el-form-item",{attrs:{label:"子模块名称","label-width":"85px",prop:"contentName"}},[a("el-input",{model:{value:e.formData.contentName,callback:function(t){e.$set(e.formData,"contentName",t)},expression:"formData.contentName"}})],1)],1)],1)]:[a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"上传程序包"}})],1)],1),e._v(" "),a("uploader",{ref:"uploader",attrs:{autoStart:!1,options:e.options},on:{"file-error":e.onFileError,"file-success":e.onFileSuccess}},[a("uploader-unsupport"),e._v(" "),a("uploader-drop",[a("uploader-btn",{staticStyle:{border:"0 solid #666"}},[a("span",{staticClass:"el-button button-m-small el-button--primary el-button--mini"},[e._v("选择文件")])]),e._v(" "),a("el-button",{staticClass:"button-m-small",attrs:{size:"mini",type:"primary"},on:{click:e.fileUpload}},[e._v("开始上传")])],1),e._v(" "),a("uploader-list")],1)]],2),e._v(" "),a("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{on:{click:function(t){e.dialogVisible=!1,e.closeForm()}}},[e._v("关闭")]),e._v(" "),a("el-button",{attrs:{type:"primary"},on:{click:function(t){return e.submitForm()}}},[e._v("确定")])],1)],1)],1)],1)},staticRenderFns:[]};var u=a("VU/8")(c,d,!1,function(e){a("6erQ")},"data-v-6b3af554",null);t.default=u.exports}});